# Order API

REST API для добавления заказа по ID

## Описание

Этот проект представляет собой REST API сервис с одним POST-методом для добавления товаров в заказы. Сервис использует PostgreSQL в качестве базы данных и разбит на следующие слои:

- **Domain Layer** - модели домена и интерфейсы репозиториев
- **Infrastructure Layer** - реализация подключения к БД и репозиториев
- **Application Layer** - сервисы, контроллеры и DTO

## Установка и запуск

```bash
pip install -r requirements.txt
```

Или

```bash
cd {...}/demo_task
docker build -t task3-app ./Task3
docker-compose up -d
```

### Настройка базы данных

1. Для инициализации БД достаточно использовать init.sql файл или просто запустить docker-compose с уже предустановленными настройками
2. Далее нужно настроить параметры подключения в файле `.env`:
   ```
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=main_db
   DB_USER=postgres
   DB_PASSWORD=postgres
   ```

## API Документация

После запуска приложения документация доступна по адресам:

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## Эндпоинты

### POST /orders/add-good

Добавляет товар в существующий заказ.

**Параметры запроса:**
```json
{
  "order_id": 1,
  "good_id": 5,
  "amount": 2
}
```

**Ответы:**
- `201 Created` - товар успешно добавлен
- `400 Bad Request` - недостаточно товара на складе
- `404 Not Found` - заказ или товар не найден
- `500 Internal Server Error` - внутренняя ошибка сервера

**Особенности:**
- Если товар уже есть в заказе, его количество увеличивается
- Если товара нет в наличии, возвращается ошибка 400 с детальным сообщением
- Ответ помимо HTTP-статуса содержит поля `success` и `message`
- Таблица с товарами обновляется в соответствии с количеством добавленных в заказ штук. При постоянном вызове данного метода товар рано или поздно закончится (amount = 0).

### GET /health

Проверка состояния приложения и подключения к базе данных.

### GET /

Корневой эндпоинт с информацией о API.

## Архитектура

Все зависимости инжектируются через FastAPI DI контейнер:

- `OrderRepository` -> `OrderRepositoryImpl`
- `OrderService` зависит от `OrderRepository`

## Модели данных

### Order
- `id` - ID заказа
- `client_id` - ID клиента

### OrderedGood
- `order_id` - ID заказа
- `good_id` - ID товара
- `amount` - количество

### Good
- `id` - ID товара
- `name` - название товара
- `amount` - количество на складе
- `price` - цена
- `catalogue_id` - ID категории

## Обработка ошибок

API возвращает структурированные ответы об ошибках с соответствующими HTTP статус-кодами:

- Валидация входных данных
- Проверка существования заказов и товаров
- Проверка наличия товаров на складе
- Обработка ошибок базы данных

## Тестирование

Для тестирования API можно использовать прилагаемый скрипт test_api.py:

```bash
python test_api.py
```

Скрипт выполняет следующие тесты:
- Добавление товара в заказ
- Увеличение количества существующего товара
- Обработка ошибок (несуществующий заказ/товар, недостаток товара)
- Демонстрация уменьшения количества товара на складе
- Проверка состояния API
